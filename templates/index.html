<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Chat Popup</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }

    #chatToggleBtn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 28px;
      cursor: pointer;
      z-index: 1000;
    }

    #chatPopup {
      display: none;
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 350px;
      height: 500px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
      background-color: #f7f7f7;
    }

    .chat-header button {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
    }

    .chat-body {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
    }

    .chat-option {
      margin: 10px 0;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #007bff;
      background-color: #f0f8ff;
      cursor: pointer;
      text-align: center;
      transition: 0.3s ease;
    }

    .chat-option:hover {
      background-color: #007bff;
      color: white;
    }

    .chat-history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 8px 0;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #007bff;
      background-color: #f9fcff;
      position: relative;
      cursor: default;
    }

    .chat-history-item:hover {
      background-color: #e9f3ff;
    }

    .chat-title {
      flex: 1;
      text-align: left;
      margin-right: 8px;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-title:focus {
      outline: 2px solid #007bff;
      border-radius: 4px;
    }

    .delete-btn {
      background: #ffffff;
      border: 1px solid rgba(0, 0, 0, 0.12);
      border-radius: 6px;
      font-size: 16px;
      line-height: 1;
      cursor: pointer;
      padding: 6px 8px;
      color: #c1121f;
      position: relative;
      z-index: 2;
      pointer-events: auto;
    }

    .delete-btn:hover {
      background: #fff5f5;
    }

    #faqSection {
      display: none;
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      border-top: 1px solid #ccc;
    }

    .faq-item {
      margin-bottom: 10px;
      padding: 10px;
      border: 1px solid #eee;
      border-radius: 6px;
      background-color: #fafafa;
    }

    .faq-item b {
      color: #007bff;
    }

    #faqControls {
      text-align: center;
      margin-top: 10px;
    }

    #faqControls button {
      margin: 5px;
      padding: 8px 12px;
      border: none;
      background-color: #007bff;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }

    /* Make the whole popup flex column */
#chatPopup {
  display: flex;
  flex-direction: column;
}

/* Chat interface fills remaining height */
#chatInterface {
  flex: 1;
  display: flex;
  flex-direction: column;
  height: 100%;
  overflow: hidden; /* prevents content pushing outside */
}

/* Messages area scrolls */
#chatMessages {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
  border-top: 1px solid #ccc;
  border-bottom: 1px solid #ccc;
}

/* Input fixed above footer */
#chatInputContainer {
  display: flex;
  padding: 10px;
  border-top: 1px solid #ccc;
  background: white;
  flex-shrink: 0; /* prevent shrinking */
}

#chatInput {
  flex: 1;
  resize: none;
  border: 1px solid #ccc;
  padding: 8px;
  font-size: 14px;
  border-radius: 4px;
  max-height: 100px;
  overflow-y: auto;
}

#sendBtn {
  margin-left: 10px;
  background-color: #007bff;
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 4px;
  cursor: pointer;
}

/* Footer always sticks at bottom inside popup */
.chat-footer {
  display: flex;
  justify-content: space-around;
  border-top: 1px solid #ccc;
  padding: 10px;
  background-color: #f7f7f7;
  flex-shrink: 0; /* keep fixed size */
}


    .chat-footer button {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      position: relative;
    }

    .chat-footer button:hover::after {
      content: attr(title);
      position: absolute;
      bottom: 120%;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: #fff;
      font-size: 12px;
      padding: 4px 6px;
      border-radius: 4px;
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <button id="chatToggleBtn">üí¨</button>
  <div id="chatPopup">
    <div class="chat-header">
      <button onclick="handleBack()">üîô</button>
      <strong>AI Assistant</strong>
      <button onclick="chatPopup.style.display='none'">‚ùå</button>
    </div>
    <div id="mainMenu" class="chat-body">
      <h3>How can we help?</h3>
      <div class="chat-option" onclick="showChatView()">Chat with AI</div>
      <div class="chat-option" onclick="showFAQView()">View FAQ</div>
    </div>
    <div id="chatView" class="chat-body" style="display: none;">
      <h3>Messages</h3>
      <div class="chat-option" onclick="startNewChat()">Start New Chat</div>
      <div id="chatHistoryContainer"></div>
    </div>
    <div id="chatInterface" style="display: none;">
      <div id="chatMessages"></div>
      <div id="chatInputContainer">
        <!-- changed to textarea -->
        <textarea id="chatInput" placeholder="Type your message..."></textarea>
        <button id="sendBtn">Send</button>
      </div>
    </div>
    <div id="faqSection"></div>
    <div class="chat-footer">
      <button onclick="showMainMenu()" title="Home">üè†</button>
      <button onclick="showChatView()" title="Chat">üí¨</button>
      <button onclick="showFAQView()" title="FAQ">‚ùì</button>
    </div>
  </div>
  <script>
    const USER_ID = 1; // <-- change this dynamically after login

    // FAQ Logic
    let allFaqs = []; let faqIndex = 0;
    const faqSection = document.getElementById("faqSection");
    async function showFAQView() {
      mainMenu.style.display = "none"; chatView.style.display = "none";
      chatInterface.style.display = "none"; faqSection.style.display = "block";
      if (allFaqs.length === 0) {
        const res = await fetch(`/faqs?type=startup`); // backend will filter based on DB
        allFaqs = await res.json();
      }
      faqIndex = 0; renderFaqs();
    }
    function renderFaqs() {
      faqSection.innerHTML = "<h3>FAQs</h3>";
      const slice = allFaqs.slice(0, faqIndex + 5);
      slice.forEach(f => {
        faqSection.innerHTML += `<div class="faq-item"><p><b>Q:</b> ${f.question}</p><p><b>A:</b> ${f.answer}</p></div>`;
      });
      let controlsHTML = '<div id="faqControls">';
      if (slice.length < allFaqs.length) controlsHTML += `<button onclick="loadMoreFaqs()">Show More</button>`;
      if (slice.length > 5) controlsHTML += `<button onclick="showLessFaqs()">Show Less</button>`;
      controlsHTML += '</div>'; faqSection.innerHTML += controlsHTML;
    }
    function loadMoreFaqs(){ faqIndex+=5; renderFaqs(); }
    function showLessFaqs(){ faqIndex=0; renderFaqs(); }

    const chatToggleBtn = document.getElementById('chatToggleBtn');
    const chatPopup = document.getElementById('chatPopup');
    const mainMenu = document.getElementById('mainMenu');
    const chatView = document.getElementById('chatView');
    const chatInterface = document.getElementById('chatInterface');
    const chatHistoryContainer = document.getElementById('chatHistoryContainer');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');

    let chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '[]');
    let currentSession = null;
    let previousView = 'mainMenu';
    const sessionPrefix = "session_";

    function updateChatHistoryView() {
      chatHistoryContainer.innerHTML = '';
      if (chatHistory.length === 0) {
        chatHistoryContainer.innerHTML = '<p>No previous chats.</p>';
        return;
      }
      for (let i = chatHistory.length - 1; i >= 0; i--) {
        const row = document.createElement('div');
        row.className = 'chat-history-item';
        row.dataset.idx = String(i);
        const title = document.createElement('div');
        title.className = 'chat-title';
        title.setAttribute('role', 'button');
        title.setAttribute('tabindex', '0');
        title.textContent = chatHistory[i].title || `Chat ${i + 1}`;
        title.dataset.idx = String(i);
        const delBtn = document.createElement('button');
        delBtn.className = 'delete-btn';
        delBtn.type = 'button';
        delBtn.title = 'Delete chat';
        delBtn.textContent = 'üóëÔ∏è';
        delBtn.dataset.idx = String(i);
        row.appendChild(title);
        row.appendChild(delBtn);
        chatHistoryContainer.appendChild(row);
      }
    }

    chatHistoryContainer.addEventListener('click', async (e) => {
      const del = e.target.closest('.delete-btn');
      if (del) {
        e.preventDefault();
        e.stopPropagation();
        const i = Number(del.dataset.idx);
        const session_id = sessionPrefix + i;
        try {
          const res = await fetch("/delete_chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ session_id })
          });
          const data = await res.json();
          alert(data.message || 'Deleted');
        } catch (_) { }
        chatHistory.splice(i, 1);
        localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
        updateChatHistoryView();
        return;
      }
      const open = e.target.closest('.chat-title');
      if (open) {
        const i = Number(open.dataset.idx);
        loadChatSession(i);
      }
    }, true);

    chatHistoryContainer.addEventListener('contextmenu', async (e) => {
      const title = e.target.closest('.chat-title');
      if (!title) return;
      e.preventDefault();
      const i = Number(title.dataset.idx);
      const currentName = chatHistory[i].title || `Chat ${i + 1}`;
      const newName = prompt('Enter new session name:', currentName);
      if (newName && newName.trim()) {
        chatHistory[i].title = newName.trim();
        localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
        updateChatHistoryView();
        const session_id = sessionPrefix + i;
        try {
          await fetch("/rename_chat", { 
            method: "POST", 
            headers: { "Content-Type": "application/json" }, 
            body: JSON.stringify({ session_id, new_name: newName.trim() }) 
          });
        } catch (_) { }
      }
    });

    function startNewChat() {
      const title = "Untitled Chat";
      const content = [];
      chatHistory.push({ title, content });
      currentSession = chatHistory.length - 1;
      localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
      openChatInterface();
    }
    function loadChatSession(index) {
      currentSession = index;
      openChatInterface();
      renderChatMessages();
    }
    function openChatInterface() {
      previousView = chatView.style.display === 'block' ? 'chatView' : 'mainMenu';
      mainMenu.style.display = 'none';
      chatView.style.display = 'none';
      faqSection.style.display = 'none';
      chatInterface.style.display = 'flex';
      renderChatMessages();
      chatInput.focus(); // Auto focus
    }
    function renderChatMessages() {
      const session = chatHistory[currentSession];
      chatMessages.innerHTML = '';
      session.content.forEach(msg => {
        const p = document.createElement('p');
        p.textContent = msg;
        chatMessages.appendChild(p);
      });
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    function showMainMenu() {
      previousView = 'mainMenu';
      mainMenu.style.display = 'block';
      chatView.style.display = 'none';
      chatInterface.style.display = 'none';
      faqSection.style.display = 'none';
    }
    function showChatView() {
      previousView = 'chatView';
      mainMenu.style.display = 'none';
      chatView.style.display = 'block';
      chatInterface.style.display = 'none';
      faqSection.style.display = 'none';
      updateChatHistoryView();
    }
    function handleBack() {
      if (chatInterface.style.display === 'flex') {
        previousView === 'chatView' ? showChatView() : showMainMenu();
      } else if (faqSection.style.display === 'block') {
        showMainMenu();
      }
    }

    async function sendMessage() {
      const text = chatInput.value.trim();
      if (!text || currentSession === null) return;
      const session_id = sessionPrefix + currentSession;

      if (chatHistory[currentSession].content.length === 0) {
        const words = text.split(" ");
        chatHistory[currentSession].title = words.slice(0, 3).join(" ");
      }

      chatHistory[currentSession].content.push("You: " + text);
      localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
      chatInput.value = '';
      chatInput.style.height = "auto";
      renderChatMessages();

      try {
        const res = await fetch("/chat", { 
          method: "POST", 
          headers: { "Content-Type": "application/json" }, 
          body: JSON.stringify({ session_id, user_id: USER_ID, query: text }) // ‚úÖ only send user_id now
        });
        const data = await res.json();
        if (data.response) {
          chatHistory[currentSession].content.push("AI: " + data.response);
          localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
          renderChatMessages();
        } else {
          chatHistory[currentSession].content.push("[No response from AI]");
          renderChatMessages();
        }
      } catch (err) {
        chatHistory[currentSession].content.push("[Server error]");
        renderChatMessages();
      }
    }

    sendBtn.addEventListener('click', sendMessage);

    // Auto-expand textarea + Shift+Enter new line, Enter sends
    chatInput.addEventListener('input', () => {
      chatInput.style.height = "auto";
      chatInput.style.height = (chatInput.scrollHeight) + "px";
    });
    chatInput.addEventListener('keydown', (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
      if (e.key === "Backspace" && chatInput.value === "") {
        e.preventDefault();
        handleBack();
      }
    });

    chatToggleBtn.addEventListener('click', () => {
      chatPopup.style.display = (chatPopup.style.display === 'none' || chatPopup.style.display === '') ? 'flex' : 'none';
      if (chatPopup.style.display === 'flex') {
        chatInput.focus();
      }
    });

    updateChatHistoryView();
</script>

</body>

</html>